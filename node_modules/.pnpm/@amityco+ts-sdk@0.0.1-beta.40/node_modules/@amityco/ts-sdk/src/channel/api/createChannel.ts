import { getActiveClient } from '~/client/api';

import { ingestInCache } from '~/cache/api/ingestInCache';

import { prepareChannelPayload } from '../utils';

/**
 * ```js
 * import { createChannel } from '@amityco/ts-sdk'
 * const created = await createChannel({ displayName: 'foobar' })
 * ```
 *
 * Creates an {@link Amity.Channel}
 *
 * @param bundle The data necessary to create a new {@link Amity.Channel}
 * @returns The newly created {@link Amity.Channel}
 *
 * @category Channel API
 * @async
 */
export const createChannel = async <T extends Amity.ChannelType>(
  bundle: { type: T; userIds?: Amity.User['userId'][] } & Pick<
    Amity.Channel<T>,
    'displayName' | 'avatarFileId' | 'tags' | 'metadata'
  >,
): Promise<Amity.Cached<Amity.Channel>> => {
  const client = getActiveClient();
  client.log('user/createChannel', bundle);

  let payload;

  if (bundle?.type === 'conversation') {
    payload = await client.http.post<Amity.ChannelPayload>('/api/v3/channels/conversation', {
      ...bundle,
      isDistinct: true,
    });
  } else {
    payload = await client.http.post<Amity.ChannelPayload>('/api/v3/channels', bundle);
  }

  const data = prepareChannelPayload(payload.data);

  const cachedAt = client.cache && Date.now();
  if (client.cache) ingestInCache(data, { cachedAt });

  const { channels } = data;
  return {
    data: channels[0],
    cachedAt,
  };
};
