import { disableCache, enableCache } from '~/cache/api';
import {
  client,
  connectClient,
  disconnectClient,
  pause,
  user11,
  user12,
  user21,
  userQueryResponse,
  userQueryResponsePage2,
} from '~/utils/tests';

import { liveUsers } from '../liveUsers';

const getSnapshot = (params?: Record<string, any>) => {
  return {
    data: [] as Amity.User[],
    loading: true,
    error: undefined as any,
    ...params,
  };
};

const { paging, ...payload } = userQueryResponse.data;
const { paging: paging2, ...payload2 } = userQueryResponsePage2.data;

describe('liveUsers', () => {
  beforeAll(connectClient);
  afterAll(disconnectClient);

  beforeEach(enableCache);

  afterEach(disableCache);

  const params = { sortBy: 'lastCreated' } as Amity.UserLiveCollection;

  // integration_test_id: c7cb9776-5c72-4abe-9b3c-572d74d534fe
  test('it should return users collection', async () => {
    const callback = jest.fn();
    client.http.get = jest.fn().mockResolvedValue(userQueryResponse);

    liveUsers(params, callback);
    await pause();

    expect(callback).toHaveBeenCalledTimes(2);
    expect(callback).toHaveBeenNthCalledWith(1, expect.objectContaining(getSnapshot()));
    expect(callback).toHaveBeenNthCalledWith(
      2,
      expect.objectContaining(
        getSnapshot({
          data: payload.users,
          loading: false,
        }),
      ),
    );
  });

  test('it should return data from cache', async () => {
    const callback = jest.fn();
    client.http.get = jest.fn().mockResolvedValue(userQueryResponse);

    liveUsers(params, () => undefined);
    await pause();
    liveUsers(params, callback);
    await pause();

    expect(callback).toHaveBeenCalledTimes(2);
    expect(callback).toHaveBeenNthCalledWith(
      1,
      expect.objectContaining(
        getSnapshot({
          data: payload.users,
        }),
      ),
    );
    expect(callback).toHaveBeenNthCalledWith(
      2,
      expect.objectContaining(
        getSnapshot({
          data: payload.users,
          loading: false,
        }),
      ),
    );
  });

  test('it should return method to fetch next page', async () => {
    const callback = jest.fn();
    client.http.get = jest
      .fn()
      .mockResolvedValue(userQueryResponse)
      .mockResolvedValueOnce(userQueryResponsePage2);

    liveUsers(params, callback);
    await pause();

    expect(callback).toHaveBeenCalled();
    expect(callback.mock.lastCall).toHaveLength(1);

    const { onNextPage, hasNextPage } = callback.mock.lastCall[0];

    expect(hasNextPage).toBe(true);
    expect(onNextPage).toBeTruthy();

    onNextPage();
    await pause();

    // 4 -> because 1 local & server call each per call (2)
    expect(callback).toHaveBeenCalledTimes(4);
    expect(callback).toHaveBeenNthCalledWith(
      4,
      expect.objectContaining(
        getSnapshot({
          loading: false,
          data: [...payload2.users, ...payload.users],
        }),
      ),
    );
  });

  describe('events', () => {
    const updatedUser = { ...user11, displayName: 'updated-user' };
    const flaggedUser = { ...user11, flagCount: 1 };
    const unflaggedUser = { ...user11, flagCount: 1 };
    const flagClearedUser = { ...user11, flagCount: 0 };

    const cases: [string, keyof Amity.Events, Amity.UserPayload, Amity.User[]][] = [
      [
        'it should update user in collection onUpdate',
        'user.updated',
        { users: [updatedUser], files: [] },
        [updatedUser, user12],
      ],
      [
        'it should update user in collection onUpdate',
        'user.flagged',
        { users: [flaggedUser], files: [] },
        [flaggedUser, user12],
      ],
      [
        'it should update user in collection onUpdate',
        'user.unflagged',
        { users: [unflaggedUser], files: [] },
        [unflaggedUser, user12],
      ],
      [
        'it should update user in collection onUpdate',
        'user.flagCleared',
        { users: [flagClearedUser], files: [] },
        [flagClearedUser, user12],
      ],
    ];

    test.each(cases)('%s', async (test, event, user, expected) => {
      const callback = jest.fn();
      client.http.get = jest.fn().mockResolvedValue(userQueryResponse);

      liveUsers(params, callback);
      await pause();

      client.emitter.emit(event, user);
      await pause();

      expect(callback).toHaveBeenNthCalledWith(
        3,
        expect.objectContaining(
          getSnapshot({
            data: expected,
            loading: false,
          }),
        ),
      );
    });
  });

  // integration_test_id: 60b4b354-efca-49bc-aa8b-d63a8da6ef31
  const filters: [string, Amity.UserLiveCollection, Amity.User[]][] = [
    ['displayName', { displayName: 'displayName' }, [user21]],
  ];

  test.each(filters)('it should filter by %s communities', async (filter, params, expected) => {
    const callback = jest.fn();
    client.http.get = jest.fn().mockResolvedValue(userQueryResponsePage2);

    liveUsers(params, callback);

    expect(callback).toHaveBeenCalledTimes(1);
    // check if cache data returned (should be empty)
    expect(callback).toHaveBeenCalledWith(expect.objectContaining(getSnapshot()));

    await pause();

    expect(callback).toHaveBeenCalledTimes(2);
    expect(callback).toHaveBeenCalledWith(
      expect.objectContaining(
        getSnapshot({
          loading: false,
          data: expected,
        }),
      ),
    );
  });
});
