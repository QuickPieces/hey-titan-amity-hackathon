import { getActiveClient } from '~/client/api/activeClient';

import { ingestInCache } from '~/cache/api/ingestInCache';

import { fireEvent } from '~/core/events';
import { prepareMembershipPayload } from '~/group/utils';
import { prepareMessagePayload } from '~/message/utils';
import REFERENCE_TYPES from '../constants/referenceTypes';

/**
 * ```js
 * import { deleteReport } from '@amityco/ts-sdk'
 * const unflagged = await deleteReport('post', postId)
 * ```
 *
 * @param referenceType The type of thing to delete a report to, such as a post or a comment.
 * @param referenceId The ID of the thing to delete a report to.
 * @returns the deleted report result
 *
 * @category Report API
 * @async
 * */
export const deleteReport = async (
  referenceType: keyof typeof REFERENCE_TYPES,
  referenceId: string,
): Promise<boolean> => {
  const client = getActiveClient();
  client.log('report/deleteReport', { referenceType, referenceId });

  const getAPIUrl = (): string => {
    if (referenceType === 'user') {
      return `/api/v4/me/flags/${encodeURIComponent(referenceId)}`;
    }

    if (referenceType === 'message') {
      return `/api/v5/messages/${encodeURIComponent(referenceId)}/flags`;
    }

    const { domainName } = REFERENCE_TYPES[referenceType];

    return `/api/v3/${domainName}/${encodeURIComponent(referenceId)}/unflag`;
  };

  const { data: payload } = await client.http.delete<
    Amity.PostPayload | Amity.CommentPayload | Amity.ProcessedMessagePayload | Amity.UserPayload
  >(getAPIUrl());

  if (client.cache) {
    if (referenceType === 'message') {
      ingestInCache(prepareMessagePayload(payload as Amity.MessagePayload));
    } else if (referenceType === 'post') {
      ingestInCache(prepareMembershipPayload(payload as Amity.PostPayload, 'communityUsers'));
    } else {
      ingestInCache(payload as Amity.CommentPayload | Amity.UserPayload);
    }
  }

  // @ts-ignore
  fireEvent(`${referenceType}.unflagged`, payload);

  return !!payload;
};
