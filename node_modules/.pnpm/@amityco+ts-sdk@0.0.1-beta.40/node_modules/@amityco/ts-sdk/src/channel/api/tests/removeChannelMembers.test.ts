import { getResolver } from '~/core/model';
import { pullFromCache, enableCache, disableCache } from '~/cache/api';

import {
  client,
  pause,
  channelUserQueryResponse,
  rawChannelUser,
  rawChannelUser3,
  channel1,
  channelUser,
  channelUser3,
  connectClient,
  disconnectClient,
} from '~/utils/tests';

import { onChannelMemberRemoved } from '~/channel/events';

import { removeChannelMembers } from '../removeChannelMembers';

describe('removeChannelMembers', () => {
  beforeAll(connectClient);
  afterAll(disconnectClient);

  beforeEach(enableCache);
  afterEach(disableCache);

  const { channelId } = channelUserQueryResponse.data.channels[0];
  const { userId } = rawChannelUser;

  test('it should remove channel members from channel', async () => {
    client.http.delete = jest.fn().mockResolvedValueOnce(channelUserQueryResponse);

    const recieved = await removeChannelMembers(channelId, [userId]);

    expect(recieved).toBe(true);
  });

  test('it should update cache with removed channel members', async () => {
    enableCache();

    client.http.delete = jest.fn().mockResolvedValueOnce(channelUserQueryResponse);

    const channelUserCacheKey = getResolver('channelUsers')({
      channelId,
      userId,
    });

    const recieved = await removeChannelMembers(channelId, [userId]);
    const recievedCache = pullFromCache<Amity.Membership<'channel'>>([
      'channelUsers',
      'get',
      channelUserCacheKey,
    ])?.data;

    expect(recieved).toBe(true);
    expect(recievedCache).toBeDefined();
    expect(recievedCache).toEqual(channelUser);

    disableCache();
  });

  test('it should fire event when members are removed', async () => {
    expect.assertions(1);

    client.http.delete = jest.fn().mockResolvedValueOnce(channelUserQueryResponse);
    let dispose;

    const callback = new Promise(resolve => {
      dispose = onChannelMemberRemoved(resolve);
    }).finally(dispose);

    await removeChannelMembers(channelId, [userId]);

    return expect(callback).resolves.not.toThrow();
  });

  test('it should fire event with all removed members', async () => {
    client.http.delete = jest.fn().mockResolvedValueOnce(channelUserQueryResponse);

    const callback = jest.fn();
    const { userId: userId2 } = rawChannelUser3;
    const unsub = onChannelMemberRemoved(callback);

    const recieved = await removeChannelMembers(channelId, [userId, userId2]);

    expect(recieved).toBe(true);

    await pause();

    /*
     * Assertion below is required to check if the event handler is called with the right
     * params. It's not enough to check if the handler does not throw
     */
    expect(callback).toHaveBeenNthCalledWith(1, channel1, channelUser);
    expect(callback).toHaveBeenNthCalledWith(2, channel1, channelUser3);

    unsub();
  });

  test('it should return an error', async () => {
    client.http.delete = jest.fn().mockRejectedValueOnce(new Error('error'));

    await expect(removeChannelMembers('channelId', [])).rejects.toThrow('error');
  });
});
