import { getActiveClient } from '~/client/api';
import { synchronousWSCall } from '~/core/transports';
import { pullFromCache, pushToCache } from '~/cache/api';

/**
 * ```js
 * import { stopReading } from '@amityco/ts-sdk'
 * const success = await stopReading('foo')
 * ```
 *
 * Stop reading message inside channel
 *
 * @param {string} subChannelId - The channel ID to stop reading.
 * @return {Promise<boolean>>} A success boolean if the sub channel reading was halted.
 *
 * @category Message API
 * @async
 */
export const stopReading = async (subChannelId: string) => {
  const client = getActiveClient();
  client.log('message/stopReading', { subChannelId });

  const subChannel = pullFromCache<Amity.SubChannel>(['subChannel', 'get', subChannelId]);

  if (!subChannel) {
    return;
  }

  const { channelId } = subChannel.data;
  const channel = pullFromCache<Amity.Channel>(['channel', 'get', channelId]);

  if (!channel || channel.data.defaultSubChannelId !== subChannelId) {
    return;
  }

  const update: Amity.Channel = {
    ...channel.data,
    // @ts-ignore
    localReading: false,
  };

  pushToCache(['channel', 'get', channelId], update);

  const result = await synchronousWSCall<Record<never, never>>(client, 'channel.stopReading', {
    channelId,
  });

  return !!result;
};
